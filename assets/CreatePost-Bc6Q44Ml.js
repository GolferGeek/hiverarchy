import{n as z,e as Q,r as m,j as r,o as V,P as D,p as u,y as J,G as d,l as _,L as M,z as x,S as j,F as b,Q as X,U as Y,V as Z,B as k}from"./vendor-BEV2JtpX.js";import{b as ee,a as te,s as g}from"./index-BPoNtoii.js";import{I as re}from"./MarkdownEditor-CiQUfrIG.js";import"./supabase-BTz4VuFi.js";import"./Delete-BxS1TgHm.js";function le(){const p=z(),{state:n}=Q(),{user:o}=ee(),{currentUsername:q}=te(),[y,w]=m.useState(!1),[v,C]=m.useState(null),[I,L]=m.useState([]),[f,P]=m.useState(""),[B,W]=m.useState([]),[s,c]=m.useState({title:"",brief_description:"",content:"",tag_names:[],tag_ids:[],interest_names:[],interest_ids:[],images:[]});m.useEffect(()=>{if(!o){p("/");return}S(),U()},[o]);async function U(){try{if(!(o!=null&&o.id)){console.log("No user ID available for fetching interests");return}const{data:e,error:t}=await g.from("interests").select("id, name, title").eq("user_id",o.id).order("sequence");if(t)throw t;W(e.map(a=>({id:a.id,value:a.name,label:a.title})))}catch(e){console.error("Error fetching interests:",e)}}async function S(){try{if(!(o!=null&&o.id)){console.log("No user ID available for fetching tags");return}const{data:e,error:t}=await g.from("tags").select("name").eq("user_id",o.id).order("name");if(t)throw t;L(e.map(a=>a.name))}catch(e){console.error("Error fetching tags:",e)}}const A=e=>{c(t=>{const a=e.id,i=e.value;return t.interest_names.includes(i)?{...t,interest_ids:t.interest_ids.filter(l=>l!==a),interest_names:t.interest_names.filter(l=>l!==i)}:{...t,interest_ids:[...t.interest_ids,a],interest_names:[...t.interest_names,i]}})},F=e=>{P(e.target.value)},N=e=>{e.key==="Enter"&&(e.preventDefault(),O(e))},O=async e=>{const t=e.target.value.trim().toLowerCase();if(t&&!s.tag_names.includes(t))try{const{data:a,error:i}=await g.from("tags").insert([{name:t,user_id:o==null?void 0:o.id}]).select().single();if(i)throw i;c(l=>({...l,tag_ids:[...l.tag_ids,a.id],tag_names:[...l.tag_names,a.name]})),e.target.value="",await S()}catch(a){console.error("Error adding tag:",a)}},T=async e=>{if(!s.tag_names.includes(e))try{const{data:t,error:a}=await g.from("tags").select("id").eq("name",e).single();if(a)throw a;c(i=>({...i,tag_ids:[...i.tag_ids,t.id],tag_names:[...i.tag_names,e]}))}catch(t){console.error("Error getting tag ID:",t)}P("")},$=e=>{c(t=>({...t,tag_names:t.tag_names.filter(a=>a!==e),tag_ids:t.tag_ids.filter((a,i)=>t.tag_names[i]!==e)}))},G=e=>{c(t=>({...t,images:[...t.images,...e]}))},H=e=>{c(t=>({...t,images:t.images.filter(a=>a!==e)}))},K=async e=>{var t;e.preventDefault(),w(!0),C(null);try{const a=n!=null&&n.parentPost?n.parentPost.arc_id:crypto.randomUUID(),{data:i,error:l}=await g.from("posts").insert([{title:s.title,brief_description:s.brief_description,content:s.content,tag_names:s.tag_names,tag_ids:s.tag_ids,interest_names:s.interest_names,interest_ids:s.interest_ids,user_id:o.id,arc_id:a,parent_id:((t=n==null?void 0:n.parentPost)==null?void 0:t.id)||null,post_writer:{status:"child_posts",version:1,content:s.brief_description||"",ideas:{ideas:[],relatedTopics:[],audiences:[],childPosts:[],futurePosts:[]},research_findings:null,refutations:null,post_outline:null,post_images:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}]).select().single();if(l)throw l;if(!(n!=null&&n.parentPost)){const{error:h}=await g.from("posts").update({arc_id:i.id}).eq("id",i.id);if(h)throw h}if(s.images&&s.images.length>0){const{error:h}=await g.from("images").insert(s.images.map(R=>({url:R.url,post_id:i.id})));if(h)throw h}p(`/${q}/post/${i.id}`)}catch(a){console.error("Error creating post:",a),C("Failed to create post. Please try again.")}finally{w(!1)}},E=I.filter(e=>e.toLowerCase().includes(f.toLowerCase())&&!s.tag_names.includes(e));return r.jsx(V,{maxWidth:"lg",sx:{mt:4,mb:4},children:r.jsxs(D,{sx:{p:4},children:[r.jsx(u,{variant:"h4",component:"h1",gutterBottom:!0,children:"Create New Post"}),v&&r.jsx(J,{severity:"error",sx:{mb:2},children:v}),r.jsx("form",{onSubmit:K,children:r.jsxs(d,{container:!0,spacing:3,children:[(n==null?void 0:n.parentPost)&&r.jsx(d,{item:!0,xs:12,children:r.jsx(_,{sx:{mb:2},children:r.jsxs(u,{variant:"body2",color:"text.secondary",children:["Creating child post for: ",r.jsx(M,{to:`/post/${n.parentPost.id}`,style:{color:"inherit",textDecoration:"underline"},children:n.parentPost.title})]})})}),r.jsx(d,{item:!0,xs:12,children:r.jsx(x,{required:!0,fullWidth:!0,label:"Title",value:s.title,onChange:e=>c(t=>({...t,title:e.target.value})),error:!s.title,helperText:s.title?"":"Title is required"})}),r.jsx(d,{item:!0,xs:12,children:r.jsx(x,{required:!0,fullWidth:!0,multiline:!0,rows:3,label:"Brief Description",placeholder:"Enter a brief description of your post",value:s.brief_description,onChange:e=>c(t=>({...t,brief_description:e.target.value})),sx:{mb:2}})}),r.jsxs(d,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Interests"}),r.jsx(j,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:B.map(e=>r.jsx(b,{label:e.label,onClick:()=>A(e),color:s.interest_names.includes(e.value)?"primary":"default",variant:s.interest_names.includes(e.value)?"filled":"outlined"},e.id))})]}),r.jsxs(d,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Tags"}),r.jsx(u,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:"Previously used tags:"}),r.jsx(j,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1,mb:2},children:I.map((e,t)=>r.jsx(b,{label:e,onClick:()=>T(e),variant:"outlined",color:s.tag_names.includes(e)?"primary":"default"},t))}),r.jsxs(_,{sx:{mb:2},children:[r.jsx(x,{fullWidth:!0,label:"Add tags",value:f,onChange:F,onKeyDown:N,helperText:"Press Enter to add a tag"}),E.length>0&&f&&r.jsx(D,{sx:{mt:1,maxHeight:200,overflow:"auto"},children:r.jsx(X,{dense:!0,children:E.map((e,t)=>r.jsx(Y,{button:!0,onClick:()=>T(e),children:r.jsx(Z,{primary:e})},t))})})]}),r.jsx(j,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:s.tag_names.map((e,t)=>r.jsx(b,{label:e,onDelete:()=>$(e)},t))})]}),r.jsxs(d,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Content"}),r.jsx(x,{required:!0,fullWidth:!0,multiline:!0,rows:10,value:s.content,onChange:e=>c(t=>({...t,content:e.target.value})),error:!s.content,helperText:s.content?"":"Content is required"})]}),r.jsxs(d,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Images"}),r.jsx(u,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:'Tip: Hover over an uploaded image and click the "Copy" icon to get the markdown code for embedding the image in your post.'}),r.jsx(re,{onUpload:G,onRemove:H,existingImages:s.images,bucket:"post-images",folder:"post-images",showCopyOption:!0})]}),r.jsx(d,{item:!0,xs:12,children:r.jsxs(_,{sx:{display:"flex",justifyContent:"flex-end",gap:2},children:[r.jsx(k,{variant:"outlined",onClick:()=>p(-1),children:"Cancel"}),r.jsx(k,{type:"submit",variant:"contained",disabled:y||!s.title||!s.content,children:y?"Creating...":"Create Post"})]})})]})})]})})}export{le as default};
//# sourceMappingURL=CreatePost-Bc6Q44Ml.js.map
