import{n as R,e as z,r as g,j as r,o as M,P as k,p as u,y as N,G as c,l as _,L as Q,z as h,S as b,F as j,Q as V,U as J,V as X,B as D}from"./vendor-BEV2JtpX.js";import{b as Y,a as Z,s as m}from"./index-CWCCNURT.js";import{I as ee}from"./MarkdownEditor-BzJKTVWG.js";import"./supabase-BTz4VuFi.js";import"./Delete-BxS1TgHm.js";function ne(){const p=R(),{state:n}=z(),{user:o}=Y(),{currentUsername:L}=Z(),[y,w]=g.useState(!1),[C,v]=g.useState(null),[I,B]=g.useState([]),[f,P]=g.useState(""),[s,d]=g.useState({title:"",brief_description:"",content:"",tag_names:[],tag_ids:[],interest_names:[],interest_ids:[],images:[]}),q=[{id:"1c6d9fa6-908b-4e83-8c1e-3baf6571d6d9",value:"coder",label:"Coder"},{id:"2a8b7c9d-456e-4f12-9a3b-8c7d6e5f4e3d",value:"golfer",label:"Golfer"},{id:"3e4f5c6d-789a-4b1c-9d2e-1f2e3d4c5b6a",value:"mentor",label:"Mentor"},{id:"4d5e6f7g-890b-4c2d-ae3f-2g3h4i5j6k7l",value:"aging",label:"Aging"}];g.useEffect(()=>{if(!o){p("/");return}T()},[o]);async function T(){try{if(!(o!=null&&o.id)){console.log("No user ID available for fetching tags");return}const{data:e,error:t}=await m.from("tags").select("name").eq("user_id",o.id).order("name");if(t)throw t;B(e.map(a=>a.name))}catch(e){console.error("Error fetching tags:",e)}}const W=e=>{d(t=>{const a=e.id,i=e.label;return t.interest_names.includes(i)?{...t,interest_ids:t.interest_ids.filter(l=>l!==a),interest_names:t.interest_names.filter(l=>l!==i)}:{...t,interest_ids:[...t.interest_ids,a],interest_names:[...t.interest_names,i]}})},U=e=>{P(e.target.value)},A=e=>{e.key==="Enter"&&(e.preventDefault(),F(e))},F=async e=>{const t=e.target.value.trim().toLowerCase();if(t&&!s.tag_names.includes(t))try{const{data:a,error:i}=await m.from("tags").insert([{name:t,user_id:o==null?void 0:o.id}]).select().single();if(i)throw i;d(l=>({...l,tag_ids:[...l.tag_ids,a.id],tag_names:[...l.tag_names,a.name]})),e.target.value="",await T()}catch(a){console.error("Error adding tag:",a)}},S=async e=>{if(!s.tag_names.includes(e))try{const{data:t,error:a}=await m.from("tags").select("id").eq("name",e).single();if(a)throw a;d(i=>({...i,tag_ids:[...i.tag_ids,t.id],tag_names:[...i.tag_names,e]}))}catch(t){console.error("Error getting tag ID:",t)}P("")},G=e=>{d(t=>({...t,tag_names:t.tag_names.filter(a=>a!==e),tag_ids:t.tag_ids.filter((a,i)=>t.tag_names[i]!==e)}))},O=e=>{d(t=>({...t,images:[...t.images,...e]}))},$=e=>{d(t=>({...t,images:t.images.filter(a=>a!==e)}))},H=async e=>{var t;e.preventDefault(),w(!0),v(null);try{const a=n!=null&&n.parentPost?n.parentPost.arc_id:crypto.randomUUID(),{data:i,error:l}=await m.from("posts").insert([{title:s.title,brief_description:s.brief_description,content:s.content,tag_names:s.tag_names,tag_ids:s.tag_ids,interest_names:s.interest_names,interest_ids:s.interest_ids,user_id:o.id,arc_id:a,parent_id:((t=n==null?void 0:n.parentPost)==null?void 0:t.id)||null,post_writer:{status:"child_posts",version:1,content:s.brief_description||"",ideas:{ideas:[],relatedTopics:[],audiences:[],childPosts:[],futurePosts:[]},research_findings:null,refutations:null,post_outline:null,post_images:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}]).select().single();if(l)throw l;if(!(n!=null&&n.parentPost)){const{error:x}=await m.from("posts").update({arc_id:i.id}).eq("id",i.id);if(x)throw x}if(s.images&&s.images.length>0){const{error:x}=await m.from("images").insert(s.images.map(K=>({url:K.url,post_id:i.id})));if(x)throw x}p(`/${L}/post/${i.id}`)}catch(a){console.error("Error creating post:",a),v("Failed to create post. Please try again.")}finally{w(!1)}},E=I.filter(e=>e.toLowerCase().includes(f.toLowerCase())&&!s.tag_names.includes(e));return r.jsx(M,{maxWidth:"lg",sx:{mt:4,mb:4},children:r.jsxs(k,{sx:{p:4},children:[r.jsx(u,{variant:"h4",component:"h1",gutterBottom:!0,children:"Create New Post"}),C&&r.jsx(N,{severity:"error",sx:{mb:2},children:C}),r.jsx("form",{onSubmit:H,children:r.jsxs(c,{container:!0,spacing:3,children:[(n==null?void 0:n.parentPost)&&r.jsx(c,{item:!0,xs:12,children:r.jsx(_,{sx:{mb:2},children:r.jsxs(u,{variant:"body2",color:"text.secondary",children:["Creating child post for: ",r.jsx(Q,{to:`/post/${n.parentPost.id}`,style:{color:"inherit",textDecoration:"underline"},children:n.parentPost.title})]})})}),r.jsx(c,{item:!0,xs:12,children:r.jsx(h,{required:!0,fullWidth:!0,label:"Title",value:s.title,onChange:e=>d(t=>({...t,title:e.target.value})),error:!s.title,helperText:s.title?"":"Title is required"})}),r.jsx(c,{item:!0,xs:12,children:r.jsx(h,{required:!0,fullWidth:!0,multiline:!0,rows:3,label:"Brief Description",placeholder:"Enter a brief description of your post",value:s.brief_description,onChange:e=>d(t=>({...t,brief_description:e.target.value})),sx:{mb:2}})}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Interests"}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:q.map(e=>r.jsx(j,{label:e.label,onClick:()=>W(e),color:s.interest_names.includes(e.label)?"primary":"default",variant:s.interest_names.includes(e.label)?"filled":"outlined"},e.value))})]}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Tags"}),r.jsx(u,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:"Previously used tags:"}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1,mb:2},children:I.map((e,t)=>r.jsx(j,{label:e,onClick:()=>S(e),variant:"outlined",color:s.tag_names.includes(e)?"primary":"default"},t))}),r.jsxs(_,{sx:{mb:2},children:[r.jsx(h,{fullWidth:!0,label:"Add tags",value:f,onChange:U,onKeyDown:A,helperText:"Press Enter to add a tag"}),E.length>0&&f&&r.jsx(k,{sx:{mt:1,maxHeight:200,overflow:"auto"},children:r.jsx(V,{dense:!0,children:E.map((e,t)=>r.jsx(J,{button:!0,onClick:()=>S(e),children:r.jsx(X,{primary:e})},t))})})]}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:s.tag_names.map((e,t)=>r.jsx(j,{label:e,onDelete:()=>G(e)},t))})]}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Content"}),r.jsx(h,{required:!0,fullWidth:!0,multiline:!0,rows:10,value:s.content,onChange:e=>d(t=>({...t,content:e.target.value})),error:!s.content,helperText:s.content?"":"Content is required"})]}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(u,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Images"}),r.jsx(u,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:'Tip: Hover over an uploaded image and click the "Copy" icon to get the markdown code for embedding the image in your post.'}),r.jsx(ee,{onUpload:O,onRemove:$,existingImages:s.images,bucket:"post-images",folder:"post-images",showCopyOption:!0})]}),r.jsx(c,{item:!0,xs:12,children:r.jsxs(_,{sx:{display:"flex",justifyContent:"flex-end",gap:2},children:[r.jsx(D,{variant:"outlined",onClick:()=>p(-1),children:"Cancel"}),r.jsx(D,{type:"submit",variant:"contained",disabled:y||!s.title||!s.content,children:y?"Creating...":"Create Post"})]})})]})})]})})}export{ne as default};
//# sourceMappingURL=CreatePost-CbwCLEcy.js.map
