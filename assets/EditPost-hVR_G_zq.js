import{u as N,n as V,r as d,j as r,o as $,P as B,l as m,p as l,B as _,G as g,z as y,S as b,F as w,Q as z,U as Q,V as J,H as X}from"./vendor-BEV2JtpX.js";import{s as c}from"./index-BPoNtoii.js";import{S as Y}from"./Save-CzW9L6yv.js";import{M as Z,I as ee}from"./MarkdownEditor-CiQUfrIG.js";import{W as te,C as re,R as se}from"./RefutationList-BR1lsVGX.js";import"./supabase-BTz4VuFi.js";import"./Delete-BxS1TgHm.js";import"./format-BzRktsyD.js";function ue(){const{id:u}=N(),v=V(),[n,i]=d.useState({title:"",brief_description:"",content:"",tag_names:[],interest_names:[]}),[P,S]=d.useState(!0),[x,C]=d.useState(!1),[I,f]=d.useState(null),[h,p]=d.useState(""),[E,L]=d.useState([]),[D,W]=d.useState([]);d.useEffect(()=>{q(),R(),O()},[u]);const q=async()=>{try{S(!0);const{data:e,error:t}=await c.from("posts").select("*").eq("id",u).single();if(t)throw t;const{data:s,error:a}=await c.from("images").select("id, url").eq("post_id",u);a&&console.error("Error fetching images:",a),i({...e,images:s||[]})}catch(e){f(e.message)}finally{S(!1)}},R=async()=>{try{const{data:e,error:t}=await c.from("posts").select("tag_names").not("tag_names","is",null);if(t)throw t;const s=[...new Set(e.flatMap(a=>a.tag_names||[]))];L(s)}catch(e){console.error("Error fetching tag suggestions:",e)}},O=async()=>{try{const{data:e,error:t}=await c.from("interests").select("id, name").order("name");if(t)throw t;W(e.map(s=>({id:s.id,value:s.id,label:s.name})))}catch(e){console.error("Error fetching interests:",e)}},T=async e=>{e.preventDefault(),C(!0),f(null);try{const{error:t}=await c.from("posts").update({title:n.title,brief_description:n.brief_description,content:n.content,tag_names:n.tag_names,tag_ids:n.tag_ids,interest_names:n.interest_names,interest_ids:n.interest_ids,updated_at:new Date().toISOString(),post_writer:{...n.post_writer,updated_at:new Date().toISOString()}}).eq("id",u);if(t)throw t;v(`/${n.username}/post/${u}`)}catch(t){console.error("Error updating post:",t),f("Failed to update post. Please try again.")}finally{C(!1)}},U=e=>{i(t=>{const s=e.id,a=e.label;return t.interest_names.includes(a)?{...t,interest_ids:t.interest_ids.filter(o=>o!==s),interest_names:t.interest_names.filter(o=>o!==a)}:{...t,interest_ids:[...t.interest_ids,s],interest_names:[...t.interest_names,a]}})},A=e=>{p(e.target.value)},F=e=>{e.key==="Enter"&&h.trim()&&(j(h.trim()),p(""))},j=async e=>{try{let{data:t,error:s}=await c.from("tags").select("id, name").eq("name",e).single();if(s&&s.code!=="PGRST116")throw s;if(!t){const{data:a,error:o}=await c.from("tags").insert([{name:e}]).select().single();if(o)throw o;t=a}i(a=>a.tag_names.includes(e)?a:{...a,tag_names:[...a.tag_names,e],tag_ids:[...a.tag_ids||[],t.id]}),p("")}catch(t){console.error("Error handling tag:",t)}},G=e=>{i(t=>{const s=t.tag_names.indexOf(e),a=t.tag_names.filter(K=>K!==e),o=[...t.tag_ids||[]];return s!==-1&&o.splice(s,1),{...t,tag_names:a,tag_ids:o}})},H=async e=>{try{const{data:t,error:s}=await c.from("images").insert([{url:e[0],post_id:u}]).select();if(s)throw s;i(a=>({...a,images:[...a.images,t[0]]}))}catch(t){console.error("Error saving image:",t)}},M=async e=>{try{const{error:t}=await c.from("images").delete().eq("id",e);if(t)throw t;i(s=>({...s,images:s.images.filter(a=>a.id!==e)}))}catch(t){console.error("Error removing image:",t)}},k=E.filter(e=>e.toLowerCase().includes(h.toLowerCase())&&!n.tag_names.includes(e));return P?r.jsx("div",{children:"Loading..."}):I?r.jsxs("div",{children:["Error: ",I]}):n?r.jsxs($,{maxWidth:"md",children:[r.jsxs(B,{sx:{p:4,mt:4},children:[r.jsxs(m,{sx:{mb:4},children:[r.jsx(l,{variant:"h4",component:"h1",gutterBottom:!0,children:"Edit Post"}),r.jsxs(m,{sx:{display:"flex",gap:2},children:[r.jsx(_,{variant:"contained",color:"primary",startIcon:r.jsx(Y,{}),onClick:T,disabled:x,children:x?"Saving...":"Save"}),r.jsx(te,{postId:u})]})]}),r.jsx(m,{component:"form",noValidate:!0,sx:{mt:1},children:r.jsxs(g,{container:!0,spacing:3,children:[r.jsx(g,{item:!0,xs:12,children:r.jsx(y,{margin:"normal",required:!0,fullWidth:!0,label:"Title",value:n.title,onChange:e=>i(t=>({...t,title:e.target.value})),disabled:x})}),r.jsx(g,{item:!0,xs:12,children:r.jsx(y,{required:!0,fullWidth:!0,multiline:!0,rows:3,label:"Brief Description",placeholder:"Enter a brief description of your post",value:n.brief_description,onChange:e=>i(t=>({...t,brief_description:e.target.value})),sx:{mb:2}})}),r.jsxs(g,{item:!0,xs:12,children:[r.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Interests"}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:D.map(e=>r.jsx(w,{label:e.label,onClick:()=>U(e),color:n.interest_names.includes(e.label)?"primary":"default",variant:n.interest_names.includes(e.label)?"filled":"outlined"},e.value))})]}),r.jsxs(g,{item:!0,xs:12,children:[r.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Tags"}),r.jsx(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:"Previously used tags:"}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1,mb:2},children:E.map((e,t)=>r.jsx(w,{label:e,onClick:()=>j(e),variant:"outlined",color:n.tag_names.includes(e)?"primary":"default"},t))}),r.jsxs(m,{sx:{mb:2},children:[r.jsx(y,{fullWidth:!0,label:"Add tags",value:h,onChange:A,onKeyDown:F,helperText:"Press Enter to add a tag"}),k.length>0&&h&&r.jsx(B,{sx:{mt:1,maxHeight:200,overflow:"auto"},children:r.jsx(z,{dense:!0,children:k.map((e,t)=>r.jsx(Q,{button:!0,onClick:()=>j(e),children:r.jsx(J,{primary:e})},t))})})]}),r.jsx(b,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:n.tag_names.map((e,t)=>r.jsx(w,{label:e,onDelete:()=>G(e)},t))})]}),r.jsxs(g,{item:!0,xs:12,children:[r.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Content"}),r.jsx(m,{sx:{mt:2},children:r.jsx(Z,{value:n.content,onChange:e=>i(t=>({...t,content:e}))})})]}),r.jsxs(g,{item:!0,xs:12,children:[r.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Images"}),r.jsx(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:1},children:'Tip: Hover over an uploaded image and click the "Copy" icon to get the markdown code for embedding the image in your post.'}),r.jsx(ee,{onUpload:H,onRemove:M,existingImages:n.images,bucket:"post-images",folder:"post-images",showCopyOption:!0})]})]})}),r.jsxs(m,{sx:{mt:4},children:[r.jsx(l,{variant:"h5",gutterBottom:!0,children:"Comments"}),r.jsx(re,{postId:n.id})]}),r.jsx(X,{sx:{my:4}}),r.jsxs(m,{sx:{mt:4},children:[r.jsx(l,{variant:"h5",gutterBottom:!0,children:"Refutations"}),r.jsx(se,{postId:n.id})]})]}),r.jsxs(m,{sx:{mt:4,display:"flex",justifyContent:"flex-end",gap:2},children:[r.jsx(_,{variant:"outlined",onClick:()=>v(-1),children:"Cancel"}),r.jsx(_,{variant:"contained",onClick:T,disabled:x,children:x?"Saving...":"Save Changes"})]})]}):r.jsx("div",{children:"Post not found"})}export{ue as default};
//# sourceMappingURL=EditPost-hVR_G_zq.js.map
